# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

Project overview
- This is a Chrome MV3 extension built with Plasmo, React, and TypeScript. It targets YouTube watch pages and provides a dual-mode subtitle experience plus a hover dictionary and flashcard creation.
- Key tech: Plasmo (build/dev/packaging), Apollo Client against https://api.bundai.app/graphql, kuromoji tokenizer, Tailwind CSS, and a bundled JMdict subset for offline lookups.

Commands
- Install dependencies (pnpm is used in this repo):
  ```bash path=null start=null
  pnpm install
  ```
- Start development (hot reload):
  ```bash path=null start=null
  pnpm dev
  ```
  Then load the dev build into Chrome from build/chrome-mv3-dev (chrome://extensions > Developer mode > Load unpacked).
- Production build:
  ```bash path=null start=null
  pnpm build
  ```
  Outputs a production build under build/.
- Package a zip for stores:
  ```bash path=null start=null
  pnpm run package
  ```
- Format (Prettier is configured, no ESLint in repo):
  ```bash path=null start=null
  pnpm prettier --check .
  pnpm prettier --write .
  ```
- Tests: No test framework or scripts are configured at this time.

High-level architecture
- Plasmo + MV3 layout
  - Plasmo generates the .plasmo/ folder and dev/prod build outputs under build/. The effective manifest is produced at .plasmo/chrome-mv3.plasmo.manifest.json.
  - Permissions and web_accessible_resources enable kuromoji dictionaries and the local JMdict JSON to be loaded by content scripts on YouTube.

- Background service worker (background.ts)
  - Centralizes extension state in memory with persistence via storage (requires PLASMO_SECURE_STORAGE_PASSWORD in .env.*). State keys:
    - extensionEnabled
    - useAutoGeneratedSubtitles
  - Responds to runtime messages:
    - addFlashCard: calls the backend GraphQL mutation (with token from secure storage)
    - getExtensionState / setExtensionEnabled
    - getUseAutoGeneratedSubtitles / setUseAutoGeneratedSubtitles
  - Broadcasts state changes to all youtube.com tabs so content scripts can react immediately.

- Content scripts (two complementary modes)
  1) contents/auto-subtitle-extractor.tsx
     - Hooks into YouTube’s native captions, tokenizes Japanese text using kuromoji, and renders a React WordCard near the captions on hover.
     - Uses a MutationObserver to re-tokenize when caption DOM updates and event delegation for stable hover handling.
     - Loads a bundled JMdict JSON (assets/data/japanese/jmdict-simplified-flat-full.json) and builds in-memory indices for kanji/kana lookups.
     - Enabled when both extensionEnabled and useAutoGeneratedSubtitles are true (as provided by background).
  2) contents/custom-subtitles-container.tsx
     - Renders an independent subtitle overlay (two tracks) on top of the video with adjustable styling.
     - Finds the primary video element and manages a root container for custom subtitles and the WordCard React portal.
     - Also uses kuromoji and the same JMdict indices; state is enabled when extensionEnabled is true and useAutoGeneratedSubtitles is false.

- UI components and hooks
  - components/WordCard.tsx: Displays dictionary details for the hovered word, shows romaji via wanakana, and can trigger a flashcard add (delegated to background via hooks).
  - components/SubtitlesSection.tsx: Lets the user pick two subtitle URLs (per-video) and sends messages to the content script on the active tab to load them.
  - hooks/useFlashcardService.ts: Orchestrates addFlashCard flow. It reads userId/token from secure storage, tries background messaging first, then falls back to a direct GraphQL POST if needed.
  - hooks/useSubtitle.ts: Fetches available subtitle URLs for a YouTube videoId from the backend (VTT format), exposing loading/error state and a refetch method.

- GraphQL layer
  - graphql/index.ts configures ApolloClient to https://api.bundai.app/graphql with a simple cache.
  - graphql/mutations/* contains document nodes for sign-up/login/verification and addFlashCard. Background.ts uses ADD_FLASH_CARD_MUTATION to add a card.

- Styling
  - Tailwind is wired via tailwind.config.js and style.css (which includes @tailwind directives). Content scripts inject CSS using Plasmo’s getStyle to avoid conflicts.
  - style.css also defines “bundai-*” classes that explicitly reset inherited styles to avoid YouTube player CSS interference.

Configuration and environment
- TypeScript config extends Plasmo’s base (tsconfig.json) and defines a path alias ~* to the repo root for concise imports.
- Secure storage: .env.development / .env.production define PLASMO_SECURE_STORAGE_PASSWORD. This is required for reading/writing auth tokens and userId used by flashcard actions.
- Manifest and permissions (effective manifest in .plasmo/chrome-mv3.plasmo.manifest.json):
  - Matches focus on *://*.youtube.com/watch* for the content scripts.
  - host_permissions include YouTube, localhost (8000, 3000), and api.bundai.app.
  - Web-accessible resources allow kuromoji dictionaries and the JMdict JSON to be fetched by the content scripts.

Important notes from README
- Development: pnpm run dev, then load build/chrome-mv3-dev into Chrome.
- Production: pnpm run build.
- Submission: the project references Plasmo’s bpp GitHub Action for automated store submission after an initial manual upload.
